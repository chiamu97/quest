<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivo di Sicurezza - Poison Protocol</title>
    <style>
        /* --- SFONDO E EFFETTO VELENO --- */
        body {
            background-color: #111; /* Sfondo base scuro */
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
            position: relative; /* Necessario per posizionare il veleno */
            /* Variabile CSS che controlleremo con JS per l'altezza del veleno */
            --poison-height: 0%; 
        }

        /* Lo strato del "Veleno" */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--poison-height); /* L'altezza è dinamica */
            /* Sfumatura verde tossico */
            background: linear-gradient(to bottom, rgba(15, 56, 15, 0.9) 0%, rgba(42, 122, 42, 0.8) 100%);
            z-index: 0; /* Sta dietro il tastierino ma davanti allo sfondo nero */
            transition: height 1s linear; /* Scende fluidamente ogni secondo */
            pointer-events: none; /* Non blocca i click */
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.3); /* Un leggero bagliore tossico sul bordo inferiore */
        }

        /* --- CONTENITORE TASTIERINO --- */
        .container {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.9);
            border: 4px solid #444;
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            z-index: 10; /* Deve stare sopra il veleno */
        }

        .header-label {
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }

        /* Timer con sfondo modificabile */
        #timer {
            font-size: 3.2rem;
            color: #ff0000;
            text-align: center;
            background-color: #000;
            padding: 10px 0;
            border: 2px solid #555;
            border-radius: 4px;
            text-shadow: 0 0 10px #ff0000;
            font-weight: bold;
            transition: background-color 0.2s, color 0.2s;
        }

        /* Display del Codice */
        #display {
            background-color: #0f380f;
            color: #00ff00;
            font-size: 1.5rem;
            height: 45px;
            line-height: 45px;
            text-align: center;
            border: 2px inset #555;
            border-radius: 4px;
            letter-spacing: 4px;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            transition: background-color 0.2s;
        }

        .display-error {
            background-color: #500 !important;
            color: #fff !important;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        button {
            background: linear-gradient(180deg, #444, #333);
            border: 1px solid #222;
            color: #ddd;
            font-size: 1.3rem;
            padding: 12px 0;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.05s;
            box-shadow: 0 3px 0 #111;
            font-family: inherit;
        }

        button:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #111;
            background: #222;
        }

        .btn-clear {
            background: linear-gradient(180deg, #d4a017, #b8860b);
            color: #000;
            font-weight: bold;
            box-shadow: 0 3px 0 #684a04;
            border: 1px solid #684a04;
        }
        
        .btn-enter {
            background: linear-gradient(180deg, #2e8b57, #1e5b39);
            color: #fff;
            box-shadow: 0 3px 0 #0f381e;
            border: 1px solid #0f381e;
        }

        #message {
            text-align: center;
            height: 20px;
            font-weight: bold;
            color: #ff4444;
            font-size: 0.9rem;
            margin-top: -5px;
        }

        .shake { animation: shake 0.4s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* Overlay Finali */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            justify-content: center; align-items: center;
            flex-direction: column;
            z-index: 100;
            text-align: center;
        }
        
        .boom { background-color: #aa0000; color: #fff; animation: flashRed 0.5s infinite; }
        .safe { background-color: #2e8b57; color: #fff; }

        @keyframes flashRed {
            0%, 100% { background-color: #aa0000; }
            50% { background-color: #ff0000; }
        }

    </style>
</head>
<body>

    <div class="container" id="bombbox">
        <div class="header-label">Protocollo Attivo</div>
        <div id="timer">15:00</div>
        <div id="display"></div>
        <div id="message"></div>

        <div class="keypad">
            <button onclick="press(1)">1</button>
            <button onclick="press(2)">2</button>
            <button onclick="press(3)">3</button>
            <button onclick="press(4)">4</button>
            <button onclick="press(5)">5</button>
            <button onclick="press(6)">6</button>
            <button onclick="press(7)">7</button>
            <button onclick="press(8)">8</button>
            <button onclick="press(9)">9</button>
            <button class="btn-clear" onclick="clearInput()">C</button>
            <button onclick="press(0)">0</button>
            <button class="btn-enter" onclick="checkCode()">OK</button>
        </div>
    </div>

    <div id="overlay-boom" class="overlay boom">
        <div style="font-size: 5rem; font-weight:bold;">CONTAMINAZIONE</div>
        <div style="font-size: 2rem; margin-top:20px;">Tempo Scaduto</div>
    </div>
    
    <div id="overlay-safe" class="overlay safe">
        <div style="font-size: 4rem; font-weight:bold;">DISINNESCATO</div>
        <div style="font-size: 1.5rem; margin-top:20px;">Area Sicura</div>
    </div>

    <script>
        // --- CONFIGURAZIONE TEMPO ---
        const TOTAL_TIME_MINUTES = 15;
        // Calcoliamo i secondi totali per sapere la percentuale
        const TOTAL_TIME_SECONDS = TOTAL_TIME_MINUTES * 60; 
        let timeRemaining = TOTAL_TIME_SECONDS;
        
        const CORRECT_CODE = "34542424";
        // ----------------------

        let currentInput = "";
        let timerInterval;
        let isGameActive = true;
        
        // --- AUDIO ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        document.body.addEventListener('click', function() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { once: true });

        function playTone(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playBeep() { playTone(800, 'square', 0.1); }
        function playErrorSound() { 
            playTone(150, 'sawtooth', 0.4); 
            setTimeout(() => playTone(100, 'sawtooth', 0.4), 100);
        }
        function playSuccessSound() {
            playTone(600, 'sine', 0.1);
            setTimeout(() => playTone(800, 'sine', 0.1), 100);
            setTimeout(() => playTone(1200, 'sine', 0.4), 200);
        }
        function playExplosionSound() {
            const bufferSize = audioCtx.sampleRate * 2; 
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const gain = audioCtx.createGain();
            gain.gain.value = 0.5;
            noise.connect(gain);
            gain.connect(audioCtx.destination);
            noise.start();
        }

        // --- LOGICA GIOCO ---
        const displayElement = document.getElementById('display');
        const timerElement = document.getElementById('timer');
        const messageElement = document.getElementById('message');
        const bombBox = document.getElementById('bombbox');

        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeRemaining <= 0) {
                    gameOver();
                } else {
                    timeRemaining--;
                    updateTimerDisplay();
                    
                    // Suono beep negli ultimi 10 secondi
                    if (timeRemaining < 10 && timeRemaining > 0) {
                        playTone(1000, 'sine', 0.05);
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // --- CALCOLO EFFETTO VELENO ---
            // Calcola quanto tempo è passato
            const timeElapsed = TOTAL_TIME_SECONDS -
